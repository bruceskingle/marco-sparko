query accountPropertiesMeters($accountNumber: String!) @ms_required_by_default {
  account(accountNumber: $accountNumber) {
    properties {
      id
      address
      postcode
      occupancyPeriods {
        id
        effectiveFrom
        effectiveTo @ms_optional
        isOccupier
      }
      coordinates {
        latitude
        longitude
      }
      
      electricityMeterPoints {
        id
        supplyEndDate @ms_optional
        mpan
        status
        meters {
          nodeId
          serialNumber
          consumptionUnits
          hasAndAllowsHhReadings
          importMeter @ms_optional {
            id
            nodeId
            serialNumber
          }
        }
      }
      gasMeterPoints {
        id
        supplyEndDate @ms_optional
        mprn
        status
        meters {
          nodeId
          serialNumber
          consumptionUnits
          hasAndAllowsHhReadings
        }
      }
      smartDeviceNetworks {
        smartDevices {
          deviceId
          type
        }
      }
    }
  }
}

query meterAgreements($meterNodeId: ID!, $validAfter: DateTime) @ms_required_by_default {
  node(id: $meterNodeId) {
    ... on ElectricityMeterType @ms_required_by_default {
      importMeter @ms_optional {
        meterPoint: meterPoint {
          mpan
        }
      }
      meterPoint {
        mpan
        agreements(excludeFuture: false, validAfter: $validAfter, includeInactive: true) {
          id
          validFrom
          validTo @ms_optional
          tariff {
            ... on HalfHourlyTariff @ms_required_by_default {
              displayName
              fullName
              standingCharge @ms_optional
              unitRates {
                validFrom
                validTo
                preVatValue
                value
              }
              description
              preVatStandingCharge @ms_optional
              productCode
              tariffCode
            }
            ... on StandardTariff @ms_required_by_default {
              id
              description
              displayName
              fullName
              preVatStandingCharge @ms_optional
              preVatUnitRate
              standingCharge @ms_optional
              tariffCode
              unitRate
            }
            ... on DayNightTariff @ms_required_by_default {
              id
              dayRate
              description
              displayName
              fullName
              nightRate
              preVatDayRate
              preVatNightRate
              preVatStandingCharge @ms_optional
              standingCharge @ms_optional
              tariffCode
            }
            ... on ThreeRateTariff @ms_required_by_default {
              id
              dayRate
              description
              displayName
              fullName
              nightRate
              offPeakRate
              preVatDayRate
              preVatNightRate
              preVatOffPeakRate
              preVatStandingCharge @ms_optional
              standingCharge @ms_optional
              tariffCode
            }
            ... on PrepayTariff @ms_required_by_default {
              id
              displayName
              fullName
              preVatStandingCharge @ms_optional
              preVatUnitRate
              productCode
              standingCharge @ms_optional
              tariffCode
              unitRate
            }
          }
        }
      }
    }
    ... on GasMeterType @ms_required_by_default {
      meterPoint {
        agreements(excludeFuture: false, validAfter: $validAfter) @ms_required_by_default {
          id
          validFrom
          validTo @ms_optional
          tariff {
            fullName
            tariffCode
            standingCharge @ms_optional
            preVatUnitRate
            unitRate
          }
        }
      }
    }
  }
}

query electricityAgreementLineItems($agreementId: ID!, $startAt: DateTime!, $first: Int, $timezone: String!, $itemType: LineItemTypeOptions!, $lineItemGrouping: LineItemGroupingOptions!, $after: String) @ms_required_by_default {
  electricityAgreement(id: $agreementId) @ms_required_by_default {
    ... on ElectricityAgreementType  @ms_required_by_default{
      meterPoint {
        mpan
      }
      lineItems(first: $first, grouping: $lineItemGrouping, startAt: $startAt, itemType: $itemType, timezone: $timezone, after: $after) {
        ...lineItems
      }
    }
  }
}

fragment lineItems on LineItemConnection @ms_required_by_default {
  edges {
    node {
      startAt
      endAt
      netAmount
      numberOfUnits
      settlementUnit
    }
    cursor
  }
  pageInfo {
    hasNextPage
    hasPreviousPage
    endCursor
    startCursor
  }
}

query gasAgreementLineItems($agreementId: ID!, $startAt: DateTime!, $first: Int, $timezone: String!, $itemType: LineItemTypeOptions!, $lineItemGrouping: LineItemGroupingOptions!, $after: String) @ms_required_by_default {
  gasAgreement(id: $agreementId) @ms_required_by_default {
    ... on GasAgreementType  @ms_required_by_default {
      meterPoint {
        mprn
      }
      lineItems(first: $first, grouping: $lineItemGrouping, startAt: $startAt, itemType: $itemType, timezone: $timezone, after: $after) {
        ...lineItems
      }
    }
  }
}

query getCurrentDemand(
  $meterDeviceId: String!, 
  $start: DateTime, 
  $end: DateTime, 
  $grouping: TelemetryGrouping
) @ms_required_by_default {
  	smartMeterTelemetry(deviceId: $meterDeviceId
      start: $start
      end: $end
      grouping: $grouping
    ) {
    	readAt
    	demand
    }
  }

query meterConsumption($meterId: ID!, $grouping: ConsumptionGroupings!, $startAt: DateTime!, $first: Int, $timezone: String!, $after: String) @ms_required_by_default {
  node(id: $meterId) @ms_required_by_default {
    ... on ElectricityMeterType {
      ...meterFields
      importMeter: importMeter {
        id
      }
    }
    ... on GasMeterType {
      ...meterFields
    }
  }
}

fragment meterFields on Meter @ms_required_by_default {
  consumptionUnits
  consumption(first: $first, grouping: $grouping, startAt: $startAt, timezone: $timezone, after: $after) {
    ...consumptionFields
  }
  serialNumber
}

fragment consumptionFields on ConsumptionConnection @ms_required_by_default {
  edges {
    node {
      value
      startAt
      endAt
    }
    cursor
  }
  pageInfo {
    endCursor
    hasNextPage
  }
}